// Prisma schema for AI Workflow Clinic
// Database: Supabase/Postgres

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// ENUMS
// ============================================

enum ToolCategory {
  PROJECT_MANAGEMENT
  DOCUMENTATION
  COMMUNICATION
  DEVELOPMENT
  DESIGN
  MEETINGS
  AUTOMATION
  AI_ASSISTANTS
  AI_BUILDERS
  ANALYTICS
  GROWTH
  OTHER
}

enum Complexity {
  SIMPLE
  MODERATE
  ADVANCED
  EXPERT
}

enum PricingTier {
  FREE
  FREEMIUM
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

enum TeamSize {
  SOLO
  SMALL         // 2-5
  MEDIUM        // 6-20
  LARGE         // 21-100
  ENTERPRISE    // 100+
}

enum Stage {
  BOOTSTRAPPING
  PRE_SEED
  EARLY_SEED
  GROWTH
  ESTABLISHED
}

enum TechSavviness {
  NEWBIE
  DECENT
  NINJA
}

enum RedundancyStrength {
  FULL
  PARTIAL
  NICHE
}

enum RecommendationHint {
  PREFER_A
  PREFER_B
  CONTEXT_DEPENDENT
}

enum ReplacementReasonType {
  COST_SAVINGS
  FEATURE_SUPERSET
  BETTER_INTEGRATION
  SIMPLER_UX
  CONSOLIDATION
  COMPLIANCE
  AI_NATIVE
}

enum IntegrationQuality {
  NATIVE
  DEEP
  BASIC
  WEBHOOK_ONLY
  ZAPIER_ONLY
}

enum WorkflowPhase {
  IDEATION
  PLANNING
  EXECUTION
  REVIEW
  ITERATE
  // V2 phases (reserved for future 7-phase expansion)
  DISCOVER
  DECIDE
  DESIGN
  BUILD
  LAUNCH
}

enum ConnectorType {
  NATIVE        // Built-in integration (e.g., Linear+GitHub)
  ZAPIER        // Via Zapier/Make
  API           // Custom API integration
  WEBHOOK       // Webhook-based
  BROWSER_EXT   // Browser extension bridge
  MANUAL        // Copy-paste / manual handoff
}

enum AutomationLevel {
  FULL          // No human input needed
  SUPERVISED    // Human approves AI output
  ASSISTED      // AI helps, human drives
  MANUAL        // Human does it, AI not involved
}

enum SetupDifficulty {
  PLUG_AND_PLAY // Click to enable
  GUIDED        // Follow a wizard, <30 min
  TECHNICAL     // Needs API keys or config, 1-2 hrs
  CUSTOM_DEV    // Requires developer, 1+ days
}

enum ScenarioType {
  MONO_STACK
  NATIVE_INTEGRATOR
  AGENTIC_LEAN
  STARTER_PACK
}

// ============================================
// MAIN TABLES
// ============================================

model Tool {
  id                    String        @id @default(cuid())
  name                  String        @unique // canonical lowercase name (e.g., "notion")
  displayName           String        // display name (e.g., "Notion")
  category              ToolCategory
  aliases               String[]      // alternative names/spellings

  // Use cases and features
  primaryUseCases       String[]
  keyFeatures           String[]

  // Complexity and pricing
  complexity            Complexity    @default(MODERATE)
  typicalPricingTier    PricingTier   @default(FREEMIUM)
  estimatedCostPerUser  Float?        // monthly cost per user in USD
  hasFreeForever        Boolean       @default(false)

  // Best-fit criteria
  bestForTeamSize       TeamSize[]
  bestForStage          Stage[]
  bestForTechSavviness  TechSavviness[]

  // Compliance capabilities
  soc2                  Boolean       @default(false)
  hipaa                 Boolean       @default(false)
  gdpr                  Boolean       @default(false)
  euDataResidency       Boolean       @default(false)
  selfHosted            Boolean       @default(false)
  airGapped             Boolean       @default(false)

  // AI capabilities
  hasAiFeatures         Boolean       @default(false)
  aiFeatureDescription  String?

  // URLs
  websiteUrl            String?
  logoUrl               String?

  // Popularity & Trust
  popularityScore       Int           @default(50) // 0-100 composite score
  popularityAdoption    Int           @default(50) // 0-100: market penetration, user count
  popularitySentiment   Int           @default(50) // 0-100: community love, positive reviews
  popularityMomentum    Int           @default(50) // 0-100: growth trajectory, trending
  popularityEcosystem   Int           @default(50) // 0-100: integrations, plugins, partners
  popularityReliability Int           @default(50) // 0-100: uptime, stability, maturity
  lastVerified          DateTime      @default(now())
  fundingStage          String?       // Seed, Series A, B, C, Public, Bootstrapped
  foundedYear           Int?

  // Metadata
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt

  // Relations
  integrationsFrom      ToolIntegration[]  @relation("IntegrationsFrom")
  integrationsTo        ToolIntegration[]  @relation("IntegrationsTo")
  redundancyAsA         ToolRedundancy[]   @relation("RedundancyToolA")
  redundancyAsB         ToolRedundancy[]   @relation("RedundancyToolB")
  replacementsFrom      ToolReplacement[]  @relation("ReplacementFrom")
  replacementsTo        ToolReplacement[]  @relation("ReplacementTo")
  bundleTools           BundleTool[]
  anchorBundles         ToolBundle[]       @relation("AnchorTool")
  phaseRecommendations  PhaseToolRecommendation[]

  // Workflow Intelligence relations
  phaseCapabilities     ToolPhaseCapability[]
  recipesAsTrigger      AutomationRecipe[] @relation("RecipeTriggerTool")
  recipesAsAction       AutomationRecipe[] @relation("RecipeActionTool")

  @@index([category])
  @@index([name])
  @@index([popularityScore])
}

model ToolIntegration {
  id                 String             @id @default(cuid())
  toolId             String
  integratesWithId   String
  integrationQuality IntegrationQuality
  description        String?

  tool               Tool               @relation("IntegrationsFrom", fields: [toolId], references: [id], onDelete: Cascade)
  integratesWith     Tool               @relation("IntegrationsTo", fields: [integratesWithId], references: [id], onDelete: Cascade)

  createdAt          DateTime           @default(now())

  @@unique([toolId, integratesWithId])
  @@index([toolId])
  @@index([integratesWithId])
}

model ToolRedundancy {
  id                    String             @id @default(cuid())
  toolAId               String
  toolBId               String

  overlappingUseCases   String[]
  overlappingFeatures   String[]
  redundancyStrength    RedundancyStrength
  recommendationHint    RecommendationHint

  notes                 String?

  toolA                 Tool               @relation("RedundancyToolA", fields: [toolAId], references: [id], onDelete: Cascade)
  toolB                 Tool               @relation("RedundancyToolB", fields: [toolBId], references: [id], onDelete: Cascade)

  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt

  @@unique([toolAId, toolBId])
  @@index([toolAId])
  @@index([toolBId])
}

model ToolReplacement {
  id              String                @id @default(cuid())
  fromToolId      String
  toToolId        String

  reasonType      ReplacementReasonType
  reasonText      String
  context         String?               // when this replacement makes sense
  conditions      Json?                 // JSONB for complex conditions

  fromTool        Tool                  @relation("ReplacementFrom", fields: [fromToolId], references: [id], onDelete: Cascade)
  toTool          Tool                  @relation("ReplacementTo", fields: [toToolId], references: [id], onDelete: Cascade)

  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt

  @@unique([fromToolId, toToolId])
  @@index([fromToolId])
  @@index([toToolId])
}

model ToolBundle {
  id                      String        @id @default(cuid())
  name                    String        @unique
  description             String

  // Tool roles in the bundle (stored as JSON)
  toolRoles               Json          // { toolId: "role description" }

  primaryUseCasesCovered  String[]

  // Best-fit criteria
  bestForTeamSize         TeamSize[]
  bestForStage            Stage[]
  bestForTechSavviness    TechSavviness[]

  // Anchor tool (optional)
  anchorToolId            String?
  anchorTool              Tool?         @relation("AnchorTool", fields: [anchorToolId], references: [id])

  scenarioType            ScenarioType

  // Monthly cost estimate
  estimatedMonthlyCost    Float?

  createdAt               DateTime      @default(now())
  updatedAt               DateTime      @updatedAt

  // Many-to-many with tools
  tools                   BundleTool[]

  @@index([scenarioType])
}

model BundleTool {
  id        String     @id @default(cuid())
  bundleId  String
  toolId    String
  role      String?    // role of this tool in the bundle

  bundle    ToolBundle @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  tool      Tool       @relation(fields: [toolId], references: [id], onDelete: Cascade)

  @@unique([bundleId, toolId])
  @@index([bundleId])
  @@index([toolId])
}

model PhaseToolRecommendation {
  id               String          @id @default(cuid())
  phase            WorkflowPhase
  toolId           String
  role             String          // what role does this tool play in this phase
  techSavviness    TechSavviness[]
  note             String?
  displayOrder     Int             @default(0)

  tool             Tool            @relation(fields: [toolId], references: [id], onDelete: Cascade)

  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  @@index([phase])
  @@index([toolId])
}

// ============================================
// WORKFLOW INTELLIGENCE MODELS
// ============================================

model WorkflowBucket {
  id            String          @id @default(cuid())
  phase         WorkflowPhase
  name          String          // e.g. "Problem Discovery", "Market Research"
  slug          String          @unique // e.g. "ideation-problem-discovery"
  description   String
  displayOrder  Int             @default(0)
  inputs        String[]        // what this bucket needs
  outputs       String[]        // what this bucket produces

  capabilities  ToolPhaseCapability[]

  createdAt     DateTime        @default(now())

  @@index([phase])
}

model ToolPhaseCapability {
  id              String          @id @default(cuid())
  toolId          String
  bucketId        String
  featureName     String          // e.g. "Linear Asks", "Cursor Composer"
  aiAction        String          // what AI does with this feature
  humanAction     String          // what human does
  artifact        String          // what gets produced
  automationLevel AutomationLevel @default(ASSISTED)
  philosophyFit   String[]        // ["Co-Pilot", "Hybrid", "Auto-Pilot"]
  techSavviness   TechSavviness[] // which savviness levels can use this
  displayOrder    Int             @default(0)

  tool            Tool            @relation(fields: [toolId], references: [id], onDelete: Cascade)
  bucket          WorkflowBucket  @relation(fields: [bucketId], references: [id], onDelete: Cascade)

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([toolId])
  @@index([bucketId])
  @@index([toolId, bucketId])
}

model AutomationRecipe {
  id                  String          @id @default(cuid())
  triggerToolId       String
  triggerEvent        String          // e.g. "Issue status â†’ Done"
  triggerDetail       String          // additional context
  actionToolId        String
  actionType          String          // e.g. "Create PR comment"
  actionDetail        String          // additional context
  connectorType       ConnectorType   @default(NATIVE)
  connectorDetail     String?         // e.g. "via Zapier webhook"
  phases              WorkflowPhase[] // which phases this recipe applies to
  philosophyFit       String[]        // ["Co-Pilot", "Hybrid", "Auto-Pilot"]
  setupDifficulty     SetupDifficulty @default(GUIDED)
  techSavviness       TechSavviness   @default(DECENT)
  timeSavedPerWeek    Float           @default(0) // hours saved per week
  humanBehaviorChange String?         // what the human needs to change

  triggerTool         Tool            @relation("RecipeTriggerTool", fields: [triggerToolId], references: [id], onDelete: Cascade)
  actionTool          Tool            @relation("RecipeActionTool", fields: [actionToolId], references: [id], onDelete: Cascade)

  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt

  @@index([triggerToolId])
  @@index([actionToolId])
  @@index([triggerToolId, actionToolId])
}
